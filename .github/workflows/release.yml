name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build TypeScript
        run: npm run build

      - name: Create release archive
        run: |
          # Create a clean build directory
          mkdir -p release/triplanai-marketing

          # Copy necessary files
          cp -r dist release/triplanai-marketing/
          cp -r node_modules release/triplanai-marketing/
          cp package.json package-lock.json release/triplanai-marketing/
          cp -r scripts release/triplanai-marketing/
          cp install.sh uninstall-systemd-service.sh release/triplanai-marketing/
          cp .env.example release/triplanai-marketing/
          cp README.md release/triplanai-marketing/

          # Create data directory placeholder
          mkdir -p release/triplanai-marketing/data
          echo "SQLite database will be stored here" > release/triplanai-marketing/data/.gitkeep

          # Create tarball
          cd release
          tar -czf triplanai-marketing-linux-x64.tar.gz triplanai-marketing

          # Generate checksum (without path prefix so it works with sha256sum -c)
          sha256sum triplanai-marketing-linux-x64.tar.gz > triplanai-marketing-linux-x64.tar.gz.sha256
          cd ..

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            release/triplanai-marketing-linux-x64.tar.gz
            release/triplanai-marketing-linux-x64.tar.gz.sha256
          body: |
            ## TriPlan-AI Marketing Bot ${{ steps.get_version.outputs.version }}

            Pre-built release for Linux x64 systems.

            ### Installation

            ```bash
            # Download and install
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/triplanai-marketing-linux-x64.tar.gz -o triplanai-marketing.tar.gz
            tar -xzf triplanai-marketing.tar.gz
            cd triplanai-marketing

            # Configure environment
            cp .env.example .env
            nano .env  # Edit with your credentials

            # Install and start
            ./install.sh
            ```

            ### What's included
            - Compiled TypeScript (`dist/`)
            - Pre-built native modules (`node_modules/`)
            - Installation scripts
            - Documentation

            ### Checksum
            Verify your download:
            ```bash
            sha256sum -c triplanai-marketing-linux-x64.tar.gz.sha256
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
